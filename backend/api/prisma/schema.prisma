// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============== ENUMS ===============

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum ClassMode {
  ONLINE
  OFFLINE
  HYBRID
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum SessionStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum TransactionType {
  TOP_UP
  PAYMENT
  WITHDRAWAL
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  PAYMENT_RECEIVED
  CLASS_REMINDER
  SYSTEM
  MESSAGE
}

enum PopularityPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum PaymentStatus {
  PENDING
  PAID
  EXPIRED
  FAILED
  CANCELLED
}

enum TeachingType {
  ONLINE_COURSE
  TAKE_HOME
  ONLINE_PRIVATE
  PUBLIC_LESSON
}

enum Jenjang {
  SD
  SMP
  SMA
  UMUM
}

enum LessonContentType {
  VIDEO
  MODUL
  QUIZ
  FILE
}

enum ResourceType {
  MODUL
  VIDEO
  LATIHAN
  FILE
}

enum PriceModel {
  LIFETIME_ACCESS  // One-time purchase (ONLINE_COURSE)
  PER_SESSION      // Price per 60 minutes (others)
}

// =============== MODELS ===============

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  firebaseUid String   @unique
  name        String
  role        UserRole
  phone       String?
  avatar      String?
  avatarUrl   String? // NEW: Firebase Storage URL
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  studentProfile   StudentProfile?
  teacherProfile   TeacherProfile?
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")
  deviceTokens     DeviceToken[] // NEW
  notifications    Notification[] // NEW

  @@map("users")
}

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // Hashed password
  name      String
  role      String   @default("SUPER_ADMIN") // SUPER_ADMIN, EDITOR, VIEWER
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

model StudentProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  grade         String?
  school        String?
  address       String?
  parentName    String?
  parentPhone   String?
  learningGoals String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments     ClassEnrollment[]
  bookings        Booking[]
  studentLevel    StudentLevel?
  learningPoints  LearningPoint[]
  Enrollment      Enrollment[]
  ClassFeedback   ClassFeedback[]
  ClassCompletion ClassCompletion[]

  @@map("student_profiles")
}

model StudentLevel {
  id             String   @id @default(uuid())
  studentId      String   @unique
  level          Int      @default(1)
  levelName      String   @default("Level 1")
  points         Int      @default(0)
  pointsRequired Int      @default(1000)
  tier           String   @default("Free")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("student_levels")
}

model LearningPoint {
  id          String   @id @default(uuid())
  studentId   String
  points      Int
  source      String
  description String?
  createdAt   DateTime @default(now())

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([createdAt])
  @@map("learning_points")
}

model TeacherProfile {
  id     String @id @default(uuid())
  userId String @unique
  bio    String @db.Text

  // Professional Info
  title      String? // e.g., "M.Pd", "S.Psi"
  education  Json? // Array: [{degree, institution, year, field}]
  experience Int     @default(0) // Years of experience
  hourlyRate Int     @default(0)

  // Work & Certifications
  workHistory    Json? // Array: [{position, company, period, description}]
  organizations  Json? // Array: [{name, role, year}]
  certifications Json? // Array: [{name, issuer, year, url}]
  languages      Json? // Array: ["Indonesian", "English"]

  // Location & Address
  country      String?
  city         String?
  province     String?
  address      String? @db.Text // Full address
  locationDesc String? @db.Text // Teaching space description
  mapUrl       String? // Google Maps link
  mapPreview   String? // Auto-generated map preview image

  // Ratings (calculated from reviews)
  rating       Float   @default(0)
  totalReviews Int     @default(0)
  isVerified   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjects          TeacherSubject[]
  availabilitySlots AvailabilitySlot[]
  classes           Class[]
  sessions          ClassSession[]
  bookings          Booking[]
  popularTeachers   PopularTeacher[]

  @@map("teacher_profiles")
}

model PopularTeacher {
  id               String           @id @default(uuid())
  teacherProfileId String
  rank             Int
  totalBookings    Int              @default(0)
  averageRating    Float            @default(0)
  period           PopularityPeriod @default(WEEKLY)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)

  @@unique([teacherProfileId, period])
  @@index([period, rank])
  @@map("popular_teachers")
}

model Subject {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacherSubjects TeacherSubject[]
  classes         Class[]
  bookings        Booking[]

  @@map("subjects")
}

model TeacherSubject {
  id               String   @id @default(uuid())
  teacherProfileId String
  subjectId        String
  isPrimary        Boolean  @default(false)
  createdAt        DateTime @default(now())

  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  subject Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([teacherProfileId, subjectId])
  @@map("teacher_subjects")
}

model AvailabilitySlot {
  id               String   @id @default(uuid())
  teacherProfileId String
  dayOfWeek        Int
  startTime        String
  endTime          String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)

  @@index([teacherProfileId, dayOfWeek])
  @@map("availability_slots")
}

model Class {
  id               String @id @default(uuid())
  teacherProfileId String

  // Basic Info
  title            String
  subtitle         String?
  descriptionShort String  @db.Text
  descriptionLong  String  @db.Text
  subject          String

  // Categorization
  jenjang      Jenjang
  levelRange   String?
  teachingType TeachingType @default(ONLINE_COURSE)

  // Features
  mainLanguage         String  @default("Indonesian")
  captionAvailable     Boolean @default(false)
  certificateAvailable Boolean @default(false)
  features             Json?

  // Pricing
  price      Float      @default(0)
  priceModel PriceModel @default(PER_SESSION)


  // Legacy fields (keep for compatibility)
  subjectId       String?
  mode            ClassMode?
  location        String?
  maxStudents     Int        @default(1)
  pricePerSession Int        @default(0)
  duration        Int        @default(60)
  level           String     @default("ALL")

  // Status & Metadata
  isPublished   Boolean  @default(false)
  isPremium     Boolean  @default(false)
  isActive      Boolean  @default(true)
  lastUpdatedAt DateTime @updatedAt
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  teacher           TeacherProfile    @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  subjectRel        Subject?          @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  sections          ClassSection[]
  resources         ClassResource[]
  enrollments       Enrollment[]
  legacyEnrollments ClassEnrollment[]
  feedback          ClassFeedback[]
  completions       ClassCompletion[]
  sessions          ClassSession[]
  bookings          Booking[]
  materials         ClassMaterial[]
  popularClasses    PopularClass[]

  @@index([teacherProfileId])
  @@index([subjectId])
  @@index([jenjang])
  @@index([teachingType])
  @@index([isPublished])
  @@index([isActive])
  @@map("classes")
}

model PopularClass {
  id               String           @id @default(uuid())
  classId          String
  rank             Int
  totalEnrollments Int              @default(0)
  averageRating    Float            @default(0)
  period           PopularityPeriod @default(WEEKLY)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, period])
  @@index([period, rank])
  @@map("popular_classes")
}

model ClassSession {
  id               String        @id @default(uuid())
  classId          String
  teacherProfileId String
  title            String
  description      String?       @db.Text
  scheduledAt      DateTime
  duration         Int           @default(60)
  meetingUrl       String?
  notes            String?       @db.Text
  status           SessionStatus @default(SCHEDULED)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([scheduledAt])
  @@map("class_sessions")
}

model ClassEnrollment {
  id               String   @id @default(uuid())
  classId          String
  studentProfileId String
  progress         Int      @default(0)
  isActive         Boolean  @default(true)
  enrolledAt       DateTime @default(now())
  updatedAt        DateTime @updatedAt

  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  @@unique([classId, studentProfileId])
  @@index([studentProfileId])
  @@map("class_enrollments")
}

model Booking {
  id               String        @id @default(uuid())
  studentProfileId String
  teacherProfileId String
  classId          String
  subjectId        String
  scheduledAt      DateTime
  duration         Int           @default(60)
  mode             ClassMode
  totalPrice       Int
  notes            String?       @db.Text
  status           BookingStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  student     StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  teacher     TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  class       Class          @relation(fields: [classId], references: [id], onDelete: Restrict)
  subject     Subject        @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  transaction Transaction? // NEW: One-to-one relation

  @@index([studentProfileId])
  @@index([teacherProfileId])
  @@index([scheduledAt])
  @@index([status])
  @@map("bookings")
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  content    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId])
  @@index([receiverId, isRead])
  @@map("messages")
}

// =============== NEW MODELS (PHASE 3) ===============

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  String // "ios" | "android" | "web"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("device_tokens")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  body      String           @db.Text
  data      Json?
  isRead    Boolean          @default(false)
  type      NotificationType
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model Transaction {
  id          String        @id @default(uuid())
  bookingId   String        @unique
  provider    String        @default("midtrans")
  providerRef String        @unique // order_id from Midtrans
  amount      Int
  status      PaymentStatus @default(PENDING)
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([providerRef])
  @@index([status])
  @@map("transactions")
}

model ClassMaterial {
  id        String   @id @default(uuid())
  classId   String
  title     String
  fileUrl   String // /uploads/materials/xxx.pdf
  mimeType  String? // application/pdf, image/jpeg, etc
  fileType  String // "pdf", "image", "video"
  fileSize  Int // in bytes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@map("class_materials")
}

// =============== NEW CLASS ENTITY MODELS ===============

model ClassSection {
  id        String   @id @default(uuid())
  classId   String
  title     String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class   Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  lessons ClassLesson[]

  @@index([classId, order])
  @@map("class_sections")
}

model ClassLesson {
  id              String            @id @default(uuid())
  sectionId       String
  title           String
  durationMinutes Int?
  contentType     LessonContentType @default(VIDEO)
  videoUrl        String?
  contentUrl      String?
  description     String?           @db.Text
  isLocked        Boolean           @default(false)
  isPreviewable   Boolean           @default(false)
  order           Int
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  section  ClassSection     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@index([sectionId, order])
  @@map("class_lessons")
}

model ClassResource {
  id          String       @id @default(uuid())
  classId     String
  type        ResourceType
  title       String
  description String?      @db.Text
  url         String
  order       Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId, order])
  @@map("class_resources")
}

model Enrollment {
  id               String    @id @default(uuid())
  studentProfileId String
  classId          String
  enrolledAt       DateTime  @default(now())
  completedAt      DateTime?
  progressPercent  Int       @default(0)

  student        StudentProfile   @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  class          Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]

  @@unique([studentProfileId, classId])
  @@index([classId])
  @@index([studentProfileId])
  @@map("enrollments")
}

model LessonProgress {
  id              String    @id @default(uuid())
  enrollmentId    String
  lessonId        String
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  watchedDuration Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  enrollment Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     ClassLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([lessonId])
  @@map("lesson_progress")
}

model ClassFeedback {
  id               String   @id @default(uuid())
  classId          String
  studentProfileId String
  rating           Int
  comment          String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  @@unique([classId, studentProfileId])
  @@index([classId])
  @@index([rating])
  @@map("class_feedback")
}

model ClassCompletion {
  id               String   @id @default(uuid())
  studentProfileId String
  classId          String
  completedAt      DateTime @default(now())

  student StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentProfileId, classId])
  @@index([studentProfileId])
  @@index([completedAt])
  @@map("class_completions")
}
