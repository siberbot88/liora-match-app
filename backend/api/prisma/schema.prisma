// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model ClassMaterial {
  id        String   @id @default(uuid())
  classId   String
  title     String
  fileUrl   String
  mimeType  String?
  fileType  String?
  fileSize  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@map("class_materials")
}

// =============== ENUMS ===============

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum ClassMode {
  ONLINE
  OFFLINE
  HYBRID
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum SessionStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum TransactionType {
  TOP_UP
  PAYMENT
  WITHDRAWAL
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  PAYMENT_RECEIVED
  CLASS_REMINDER
  SYSTEM
  MESSAGE
}

// =============== MODELS ===============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  firebaseUid String @unique
  name      String
  role      UserRole
  phone     String?
  avatar    String?
  avatarUrl String?  // NEW: Firebase Storage URL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentProfile   StudentProfile?
  teacherProfile   TeacherProfile?
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")
  deviceTokens     DeviceToken[]   // NEW
  notifications    Notification[]  // NEW

  @@map("users")
}

model StudentProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  grade         String?
  school        String?
  address       String?
  parentName    String?
  parentPhone   String?
  learningGoals String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments ClassEnrollment[]
  bookings    Booking[]

  @@map("student_profiles")
}

model TeacherProfile {
  id           String   @id @default(uuid())
  userId       String   @unique
  bio          String   @db.Text
  education    String
  experience   Int      @default(0)
  hourlyRate   Int      @default(0)
  rating       Float    @default(0)
  totalReviews Int      @default(0)
  isVerified   Boolean  @default(false)
  address      String?
  city         String?
  province     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjects          TeacherSubject[]
  availabilitySlots AvailabilitySlot[]
  classes           Class[]
  sessions          ClassSession[]
  bookings          Booking[]

  @@map("teacher_profiles")
}

model Subject {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacherSubjects TeacherSubject[]
  classes         Class[]
  bookings        Booking[]

  @@map("subjects")
}

model TeacherSubject {
  id               String   @id @default(uuid())
  teacherProfileId String
  subjectId        String
  isPrimary        Boolean  @default(false)
  createdAt        DateTime @default(now())

  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  subject Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([teacherProfileId, subjectId])
  @@map("teacher_subjects")
}

model AvailabilitySlot {
  id               String   @id @default(uuid())
  teacherProfileId String
  dayOfWeek        Int
  startTime        String
  endTime          String
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)

  @@index([teacherProfileId, dayOfWeek])
  @@map("availability_slots")
}

model Class {
  id               String    @id @default(uuid())
  title            String
  description      String    @db.Text
  teacherProfileId String
  subjectId        String
  mode             ClassMode
  location         String?
  maxStudents      Int       @default(1)
  pricePerSession  Int       @default(0)
  duration         Int       @default(60)
  level            String    @default("ALL")
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  teacher     TeacherProfile    @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  subject     Subject           @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  enrollments ClassEnrollment[]
  sessions    ClassSession[]
  bookings    Booking[]
  materials   ClassMaterial[]   // NEW

  @@index([teacherProfileId])
  @@index([subjectId])
  @@index([isActive])
  @@map("classes")
}

model ClassSession {
  id               String        @id @default(uuid())
  classId          String
  teacherProfileId String
  title            String
  description      String?       @db.Text
  scheduledAt      DateTime
  duration         Int           @default(60)
  meetingUrl       String?
  notes            String?       @db.Text
  status           SessionStatus @default(SCHEDULED)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([scheduledAt])
  @@map("class_sessions")
}

model ClassEnrollment {
  id               String   @id @default(uuid())
  classId          String
  studentProfileId String
  progress         Int      @default(0)
  isActive         Boolean  @default(true)
  enrolledAt       DateTime @default(now())
  updatedAt        DateTime @updatedAt

  class   Class          @relation(fields: [classId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  @@unique([classId, studentProfileId])
  @@index([studentProfileId])
  @@map("class_enrollments")
}

model Booking {
  id               String        @id @default(uuid())
  studentProfileId String
  teacherProfileId String
  classId          String
  subjectId        String
  scheduledAt      DateTime
  duration         Int           @default(60)
  mode             ClassMode
  totalPrice       Int
  notes            String?       @db.Text
  status           BookingStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  student     StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  teacher     TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  class       Class          @relation(fields: [classId], references: [id], onDelete: Restrict)
  subject     Subject        @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  transaction Transaction?   // NEW: One-to-one relation

  @@index([studentProfileId])
  @@index([teacherProfileId])
  @@index([scheduledAt])
  @@index([status])
  @@map("bookings")
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  content    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId])
  @@index([receiverId, isRead])
  @@map("messages")
}

// =============== NEW MODELS (PHASE 3) ===============

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  String   // "ios" | "android" | "web"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("device_tokens")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  body      String           @db.Text
  data      Json?
  isRead    Boolean          @default(false)
  type      NotificationType
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model Transaction {
  id          String        @id @default(uuid())
  bookingId   String        @unique
  provider    String        @default("midtrans")
  providerRef String        @unique // order_id from Midtrans
  amount      Int
  status      PaymentStatus @default(PENDING)
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([providerRef])
  @@index([status])
  @@map("transactions")
}

model ClassMaterial {
  id          String   @id @default(uuid())
  classId     String
  title       String
  fileUrl     String   // /uploads/materials/xxx.pdf
  mimeType    String?  // application/pdf, image/jpeg, etc
  fileType    String   // "pdf", "image", "video"
  fileSize    Int      // in bytes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@map("class_materials")
}
